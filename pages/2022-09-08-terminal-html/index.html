<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.75">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-09-08">

<title>jkrumbiegel.com - Getting colored Julia terminal output into blog posts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: 1;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">jkrumbiegel.com</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jkrumbiegel"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Getting colored Julia terminal output into blog posts</h1>
  <div class="quarto-categories">
    <div class="quarto-category">julia</div>
    <div class="quarto-category">rust</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 8, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>Syntax highlighting greatly helps to parse and understand code. When I write blog posts, I care a lot about making it easy for readers to understand everything, therefore syntax highlighting is a must.</p>
<p>Compare this plain Julia code</p>
<div class="sourceCode">
<pre><code>function some_function(a::Int, b::Float64)
    @info "Printing $a and $b"
    print(a, " and ", b)
end</code></pre>
</div>
<p>to a syntax-highlighted version:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">some_function</span>(a<span class="op">::</span><span class="dt">Int</span>, b<span class="op">::</span><span class="dt">Float64</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@info</span> <span class="st">"Printing </span><span class="sc">$</span>a<span class="st"> and </span><span class="sc">$</span>b<span class="st">"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(a, <span class="st">" and "</span>, b)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Color helps to split the different tokens apart. It’s very easy for us to find an element of a certain color in a background of different colors, the phenomenon is called pop-out search.</p>
<section id="terminal-output-is-not-code" class="level2">
<h2 class="anchored" data-anchor-id="terminal-output-is-not-code">Terminal output is not code</h2>
<p>Syntax highlighting works great for actual code, but in some tutorials, I just want to show how it looks when running Julia commands in the REPL. Many functions print colored output because that makes it easier to parse. Let’s take stack traces for example. These are especially long and hard to parse in Julia, so a while ago I made a PR to Julia to add color and organize them a bit more clearly. However, when I want to show them in a blog post, the colors are messed up because the syntax highlighting applies code rules to text that is not code. The syntax highlighter cannot know what styles were programmed into the printing functions. Let’s take this code for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> FirstModule</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">export</span> dothis</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dothis</span>(x) <span class="op">=</span> <span class="fu">error</span>(<span class="st">"An error was encountered"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> SecondModule</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">using</span> <span class="bu">Main.FirstModule</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">export</span> dothat</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dothat</span>(x) <span class="op">=</span> <span class="fu">dothis</span>(x)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> ThirdModule</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">using</span> <span class="bu">Main.SecondModule</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dosomething</span>(x) <span class="op">=</span> <span class="fu">map</span>(dothat, x)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When I run <code>dosomething</code>, I get this in plain text, which I find very hard to read:</p>
<div class="sourceCode">
<pre><code>julia&gt; ThirdModule.dosomething(1:3)
ERROR: An error was encountered
Stacktrace:
 [1] error(s::String)
   @ Base ./error.jl:35
 [2] dothis(x::Int64)
   @ Main.FirstModule ./REPL[1]:3
 [3] dothat(x::Int64)
   @ Main.SecondModule ./REPL[2]:4
 [4] iterate
   @ ./generator.jl:47 [inlined]
 [5] _collect
   @ ./array.jl:807 [inlined]
 [6] collect_similar
   @ ./array.jl:716 [inlined]
 [7] map
   @ ./abstractarray.jl:2931 [inlined]
 [8] dosomething(x::UnitRange{Int64})
   @ Main.ThirdModule ./REPL[3]:3
 [9] top-level scope
   @ REPL[4]:1</code></pre>
</div>
<p>If I paste it in Julia syntax mode, I get this from the syntax highlighter:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>julia<span class="op">&gt;</span> ThirdModule.<span class="fu">dosomething</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">3</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ERROR<span class="op">:</span> An error was encountered</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Stacktrace<span class="op">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> [<span class="fl">1</span>] <span class="fu">error</span>(s<span class="op">::</span><span class="dt">String</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>   @ <span class="bu">Base</span> <span class="op">./</span>error.jl<span class="op">:</span><span class="fl">35</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> [<span class="fl">2</span>] <span class="fu">dothis</span>(x<span class="op">::</span><span class="dt">Int64</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>   @ <span class="bu">Main</span>.FirstModule <span class="op">./</span><span class="bu">REPL</span>[<span class="fl">1</span>]<span class="op">:</span><span class="fl">3</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> [<span class="fl">3</span>] <span class="fu">dothat</span>(x<span class="op">::</span><span class="dt">Int64</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>   @ <span class="bu">Main</span>.SecondModule <span class="op">./</span><span class="bu">REPL</span>[<span class="fl">2</span>]<span class="op">:</span><span class="fl">4</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> [<span class="fl">4</span>] iterate</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>   @ <span class="op">./</span>generator.jl<span class="op">:</span><span class="fl">47</span> [inlined]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a> [<span class="fl">5</span>] _collect</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>   @ <span class="op">./</span>array.jl<span class="op">:</span><span class="fl">807</span> [inlined]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a> [<span class="fl">6</span>] collect_similar</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>   @ <span class="op">./</span>array.jl<span class="op">:</span><span class="fl">716</span> [inlined]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a> [<span class="fl">7</span>] map</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>   @ <span class="op">./</span>abstractarray.jl<span class="op">:</span><span class="fl">2931</span> [inlined]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a> [<span class="fl">8</span>] <span class="fu">dosomething</span>(x<span class="op">::</span><span class="dt">UnitRange{Int64}</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>   @ <span class="bu">Main</span>.ThirdModule <span class="op">./</span><span class="bu">REPL</span>[<span class="fl">3</span>]<span class="op">:</span><span class="fl">3</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a> [<span class="fl">9</span>] top<span class="op">-</span>level scope</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>   @ <span class="bu">REPL</span>[<span class="fl">4</span>]<span class="op">:</span><span class="fl">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is better because at least typing information is visually split, as are numbers, but it’s not close to what my editor looks like in this screenshot:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="screenshot.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">VSCode output</figcaption><p></p>
</figure>
</div>
<p>The benefit of the original is that the three modules have different colors and each function name is consistently bolded, not just those with <code>()</code> like in the syntax-highlighted version.</p>
</section>
<section id="cant-you-just-copy-the-code-with-styling" class="level2">
<h2 class="anchored" data-anchor-id="cant-you-just-copy-the-code-with-styling">Can’t you just copy the code with styling?</h2>
<p>VSCode offers the option to “Copy as HTML” but the output of that looks a bit like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">'utf-8'</span><span class="kw">&gt;&lt;html&gt;&lt;body&gt;</span><span class="co">&lt;!--StartFragment--&gt;</span><span class="kw">&lt;pre&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">style</span><span class="ot">=</span><span class="st">'color: #000000; background-color: #ffffff; font-family: Menlo, Monaco, '</span><span class="er">Courier</span> <span class="er">New',</span> <span class="er">monospace;</span> <span class="er">font-size:</span> <span class="er">12px;'</span><span class="kw">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;span&gt;&lt;/span&gt;&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">'color: #28a745; font-weight: bold;'</span><span class="kw">&gt;</span>julia&gt; <span class="kw">&lt;/span&gt;&lt;span&gt;</span>ThirdModule.dosomething(1:3)                                     <span class="kw">&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;/span&gt;&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">'color: #cb2431; font-weight: bold;'</span><span class="kw">&gt;</span>ERROR: <span class="kw">&lt;/span&gt;&lt;span&gt;</span>An error was encountered                                         <span class="kw">&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;</span>Stacktrace:                                                             <span class="kw">&lt;/span&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div&gt;&lt;span&gt;</span> [1] <span class="kw">&lt;/span&gt;&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">'font-weight: bold;'</span><span class="kw">&gt;</span>error(<span class="kw">&lt;/span&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So colors and fonts are encoded as they were in the terminal, which might be ok for copying to a Word document, but it’s not practical for a blog. I might want to edit my color theme in the future, separately from what I used when running the code.</p>
</section>
<section id="copying-the-original-repl-output" class="level2">
<h2 class="anchored" data-anchor-id="copying-the-original-repl-output">Copying the original REPL output</h2>
<p>Colors and styles like bold and underlined are encoded as ANSI escape codes in the REPL output which gets sent to the terminal. The terminal then interprets these symbols. So the idea I had was to just store the output from a Julia session in a separate file, including the escape codes, then transform this representation into html that I can style separately.</p>
<p>Storing the output is not difficult, you can use this command to start a Julia session that logs all output to a text file, here I just typed <code>1+1</code> and then enter. The REPL session looked like this:</p>
<div class="sourceCode">
<pre><code>julia&gt; 1+1
2

julia&gt;</code></pre>
</div>
<p>The command to record was this:</p>
<div class="sourceCode">
<pre><code>julia --banner=no --color=yes 2&gt;&amp;1 | tee julia.txt</code></pre>
</div>
<p>The output file looked like this instead:</p>
<div class="sourceCode">
<pre><code>\e[?2004h\r\e[0K\e[32m\e[1mjulia&gt; \e[0m\e[0m\r\e[7C\r\e[7C1+1\r\e[0K\e[32m\e[1mjulia&gt; \e[0m\e[0m\r\e[7C1+1\r\e[10C
\e[?2004l\e[0m\e[0m2

\r\e[0K\r\e[0K\e[32m\e[1mjulia&gt; \e[0m\e[0m\r\e[7C\r\e[7C\e[?2004h\r\e[0K\e[32m\e[1mjulia&gt; \e[0m\e[0m\r\e[7C\r\e[7C
\e[?2004l\e[0m</code></pre>
</div>
<p>As you can see, this is not directly useable for copying to a blog post. And if you look closely, you can see that <code>1+1</code> appears twice instead of just once, and the <code>julia&gt;</code> prompt appears four times instead of just twice. Why is that?</p>
<p>The reason is that the REPL can’t just add characters, it can also remove them, even though all of the commands to do that are printed into the final text output. For example the <code>\r</code> character, or carriage return, removes every character back to the beginning of the current line. That’s why <code>julia</code> and <code>1+1</code> appears multiple times, because for the final visual result it got deleted again via <code>\r</code>. There’s also other commands that can move the cursor left or right, so that the following printed characters don’t appear at the end but somewhere in between, where they overwrite other characters. Just like in a terminal, in fact.</p>
<p>So how can we get to an html representation of the final output? We have to go through the output character by character and try to emulate what the terminal would have done.</p>
</section>
<section id="faking-a-terminal-with-rust" class="level2">
<h2 class="anchored" data-anchor-id="faking-a-terminal-with-rust">Faking a terminal with Rust</h2>
<p>After googling around for a bit, I found that there are prewritten libraries that can parse strings which contain ANSI escape codes. One of them was the Rust crate <a href="https://github.com/alacritty/vte">vte</a>, and because I wanted to learn Rust anyway, I chose to go with that.</p>
<p>The parser goes through the text bit by bit and calls different callback functions depending on what kind of escape sequence was read. I chose to store a vector of <code>Char</code>s and a vector of a custom style-information struct. I then implemented basic movement of a cursor along this buffer, so that <code>\r</code> and cursor commands could have the desired effect. So far, I pretend the virtual terminal has unlimited width and height, which would definitely give the wrong result with some special movement codes. But Julia doesn’t seem to use any codes that depend on screen size, just on the location of newlines, so even the barebones version works well.</p>
<p>The work-in-progress code of <code>vte2html</code> is on <a href="https://github.com/jkrumbiegel/vte2html">GitHub</a> if you want to take a look.</p>
<p>Once the full input has been read, the final vectors of chars and styles are converted into <code>&lt;span&gt;</code> tags with text in between. The 16 terminal colors are converted into special classes like <code>sgr-fg-1</code> for the first foreground color (SGR means “Select Graphic Rendition” which is what the subgroup of ANSI codes for visual style are called), so that I can apply whatever colorscheme I want with a css stylesheet.</p>
<p>I could now convert the text output to html, which looks like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;span</span> <span class="er">class</span><span class="ot">=</span><span class="st">"sgr-bold sgr-fg-3"</span><span class="kw">&gt;</span>julia&gt; <span class="kw">&lt;/span&gt;</span>1+1</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>2</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;span</span> <span class="er">class</span><span class="ot">=</span><span class="st">"sgr-bold sgr-fg-3"</span><span class="kw">&gt;</span>julia&gt; <span class="kw">&lt;/span&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So this is very clean and useable html. I wrote a tiny lua filter so I could paste this into a quarto document and have the correct styles applied, which gives this final output. I styled the div a bit like a MacOS window so that it’s clear this was the output in a window once, not source code:</p>
<div class="ansiterminal sourceCode"><pre class="sourceCode code-with-copy"><code><span class="sgr-bold sgr-fg-3">julia&gt; </span>1+1
2

<span class="sgr-bold sgr-fg-3">julia&gt; </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>